---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown]

#Vermogen scholen 
```{r}

besturen_po = read.csv("../data_files/07-besturen-po-totaal.csv", sep=";") %>% select(bevoegd_gezag = "BEVOEGD.GEZAG.NUMMER", denominatie = "DENOMINATIE")

bekostiging_bestuur = baos_2019 %>% left_join(besturen_po) %>% group_by(bevoegd_gezag) %>% summarise(
  bekostiging_bestuur = sum(totaal_bekostiging),
  vermogen_bestuur = mean(vermogen),
  drempel_bestuur = 0.10 * bekostiging_bestuur, 
  bovenmatig_vermogen = vermogen_bestuur - drempel_bestuur,
  ratio_vermogen_baten = vermogen_bestuur / bekostiging_bestuur,
  aantal_scholen = n(), 
  denominatie = denominatie
) %>% filter(bekostiging_bestuur > 3000000, vermogen_bestuur > drempel_bestuur)

bekostiging_bestuur_klein = baos_2019 %>% left_join(besturen_po) %>% group_by(bevoegd_gezag) %>% summarise(
  bekostiging_bestuur = sum(totaal_bekostiging),
  vermogen_bestuur = mean(vermogen),
  drempel_bestuur = 300000, 
  bovenmatig_vermogen = vermogen_bestuur - drempel_bestuur,
  ratio_vermogen_baten = vermogen_bestuur / bekostiging_bestuur,
  aantal_scholen = n(), 
  denominatie = denominatie
) %>% filter(bekostiging_bestuur < 3000000, vermogen_bestuur > drempel_bestuur)

sum(bekostiging_bestuur$bovenmatig_vermogen, na.rm=T)

```
Scatterplot van de verhouding vermogen/baten en het aantal scholen per bestuur
```{r}
hist(bekostiging_bestuur$ratio_vermogen_baten)
hist(bekostiging_bestuur_klein$ratio_vermogen_baten)


ggplot(bekostiging_bestuur, aes(aantal_scholen, ratio_vermogen_baten)) +
  geom_point() + theme_minimal() + labs(fill = "Aantal scholen") +
  labs(x = 'Aantal Scholen', y = 'Ratio Vermogen/Baten') + scale_y_continuous(labels = comma) 

ggplot(bekostiging_bestuur_klein, aes(aantal_scholen, ratio_vermogen_baten)) +
  geom_point() + theme_minimal() + labs(fill = "Aantal scholen") +
  labs(x = 'Aantal Scholen', y = 'Ratio Vermogen/Baten') + scale_y_continuous(labels = comma) 

ggplot(bekostiging_bestuur, aes(x=denominatie, y=vermogen_bestuur)) + geom_violin(fill="grey80") + theme_minimal() +xlab("") + ylab("Vermogen") +theme(axis.text = element_text(angle=90))
```



# Kleine scholen toeslag 
Inladen van de opheffingsnormen 
```{r}
library(readxl)
opheffings_norm <- read_excel("../data_files/opheffingsnorm_po.xlsx", sheet="Sheet1") %>%
  select(statcode=`Gemeentecode`, opheffingsnorm= `Instandhoudingsnorm`, gemeente='Gemeentenaam')  %>% mutate(
    opheffingsnorm=as.numeric(opheffingsnorm))

opheffings_norm_dubbel <- read_excel("../data_files/opheffingsnorm_po.xlsx", sheet="Sheet2") %>%
  select(gemeente='Naam gemeente', opheffingsnorm_1="Opheffingsnorm1", opheffingsnorm_2="Opheffingsnorm2")  %>% mutate(
    opheffingsnorm_1=as.numeric(opheffingsnorm_1),
    opheffingsnorm_2=as.numeric(opheffingsnorm_2))

statcode_from_gm_nummer = function(x) if(is.finite(x)) paste0('GM', paste(rep('0', 4-nchar(x)), collapse = ''), x) else NA

opheffings_norm$statcode = sapply(opheffings_norm$statcode, statcode_from_gm_nummer)
opheffings_norm = opheffings_norm %>% left_join(opheffings_norm_dubbel, by = "gemeente") %>% select(statcode, opheffingsnorm, opheffingsnorm_1, opheffingsnorm_2) %>% group_by(statcode) %>%mutate(
  opheffingsnorm_1 = sum(opheffingsnorm, opheffingsnorm_1, na.rm = T),
  opheffingsnorm_2 = sum(opheffingsnorm, opheffingsnorm_2, na.rm = T)
)
```

Dataset op basis van de hoge opheffingsnorm, lage opheffings norm en een arbitraire opheffingsnorm. 
```{r}
opheffingsnorm_random  = 100

baos_2019_opheffingsnorm_random = baos_2019 %>% left_join(opheffings_norm, by = "statcode") %>% filter(leerlingen < opheffingsnorm_random) %>% select(brin, naam_school, gemeente, pc6, bevoegd_gezag, kleine_schooltoeslag, leerlingen, opheffingsnorm, opheffingsnorm_1, opheffingsnorm_2)

baos_2019_opheffingsnorm_1 = baos_2019 %>% left_join(opheffings_norm, by = "statcode") %>% filter(leerlingen < opheffingsnorm_1) %>% select(brin, naam_school, gemeente, pc6, bevoegd_gezag, kleine_schooltoeslag, leerlingen, opheffingsnorm, opheffingsnorm_1, opheffingsnorm_2)

baos_2019_opheffingsnorm_2 = baos_2019 %>% left_join(opheffings_norm, by = "statcode") %>% filter(leerlingen < opheffingsnorm_2) %>% select(brin, naam_school, gemeente, pc6, bevoegd_gezag, kleine_schooltoeslag, leerlingen, opheffingsnorm, opheffingsnorm_1, opheffingsnorm_2)

```

Ratio kleine scholentoeslag naar scholen onder de opheffingsnorm
```{r}
kst_norm1 =sum(baos_2019_opheffingsnorm_1$kleine_schooltoeslag, na.rm=T)
kst_norm2 =sum(baos_2019_opheffingsnorm_2$kleine_schooltoeslag, na.rm=T)
kst_normr =sum(baos_2019_opheffingsnorm_random$kleine_schooltoeslag, na.rm=T)

kst_totaal = sum(baos_2019$kleine_schooltoeslag, na.rm=T)

(0.5*(kst_norm1+kst_norm2))/kst_totaal
kst_normr/kst_totaal
kst_normr
```

